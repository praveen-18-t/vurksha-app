// Prisma Schema for Notification Service

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Notification entity
model Notification {
  id              String              @id @default(uuid())
  
  // Target
  userId          String              @map("user_id")
  
  // Content
  type            NotificationType
  title           String
  body            String
  imageUrl        String?             @map("image_url")
  
  // Actions/deep links
  actionType      String?             @map("action_type")
  actionData      Json?               @map("action_data")
  
  // Delivery status
  status          NotificationStatus  @default(PENDING)
  
  // Tracking
  sentAt          DateTime?           @map("sent_at")
  readAt          DateTime?           @map("read_at")
  failedAt        DateTime?           @map("failed_at")
  failureReason   String?             @map("failure_reason")
  
  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  ORDER_UPDATE
  PAYMENT_CONFIRMATION
  DELIVERY_UPDATE
  PROMOTIONAL
  SYSTEM
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

/// Device tokens for push notifications
model DeviceToken {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  token           String
  platform        String    // ios, android, web
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@unique([userId, token])
  @@index([userId])
  @@map("device_tokens")
}

/// User notification preferences
model NotificationPreference {
  id                  String    @id @default(uuid())
  userId              String    @unique @map("user_id")
  
  // Channel preferences
  pushEnabled         Boolean   @default(true) @map("push_enabled")
  emailEnabled        Boolean   @default(true) @map("email_enabled")
  smsEnabled          Boolean   @default(false) @map("sms_enabled")
  
  // Type preferences
  orderUpdates        Boolean   @default(true) @map("order_updates")
  promotionalOffers   Boolean   @default(true) @map("promotional_offers")
  deliveryAlerts      Boolean   @default(true) @map("delivery_alerts")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  @@map("notification_preferences")
}

/// Notification templates
model NotificationTemplate {
  id              String    @id @default(uuid())
  code            String    @unique
  name            String
  
  // Template content
  titleTemplate   String    @map("title_template")
  bodyTemplate    String    @map("body_template")
  
  // Type
  type            NotificationType
  
  // Channels
  channels        String[]  // push, email, sms
  
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@map("notification_templates")
}
